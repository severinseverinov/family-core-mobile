import React from "react";
import { View, Image, StyleSheet } from "react-native";
import { createBottomTabNavigator } from "@react-navigation/bottom-tabs";
import {
  Home,
  CheckSquare,
  PawPrint,
  Utensils,
  Lock,
} from "lucide-react-native";
import { useTheme } from "../contexts/ThemeContext";
import { useAuth } from "../contexts/AuthContext"; // Auth context ekledik

import DashboardScreen from "../screens/dashboard/DashboardScreen";
import TaskScreen from "../screens/task/TaskScreen";
import PetScreen from "../screens/pets/PetScreen";
import KitchenScreen from "../screens/kitchen/KitchenScreen";
import VaultScreen from "../screens/dashboard/VaultScreen";
import SettingsScreen from "../screens/settings/SettingsScreen";

const Tab = createBottomTabNavigator();

// --- ÖZEL AVATAR BİLEŞENİ ---
// Bu bileşen, kullanıcının durumuna göre doğru resmi seçer.
const ProfileTabIcon = ({
  color,
  focused,
}: {
  color: string,
  focused: boolean,
}) => {
  const { profile } = useAuth();

  // 1. Öncelik: Kullanıcının yüklediği veya Google'dan gelen resim
  let imageSource = profile?.avatar_url ? { uri: profile.avatar_url } : null;

  // 2. Öncelik: Resim yoksa cinsiyete uygun avatar (Dicebear API kullanıyoruz)
  if (!imageSource) {
    if (profile?.gender === "female") {
      // Kadın avatarı
      imageSource = {
        uri: "https://api.dicebear.com/7.x/avataaars/png?seed=Aneka&gender=female&style=circle",
      };
    } else if (profile?.gender === "male") {
      // Erkek avatarı
      imageSource = {
        uri: "https://api.dicebear.com/7.x/avataaars/png?seed=Felix&gender=male&style=circle",
      };
    } else {
      // Cinsiyet belirtilmemişse nötr avatar
      imageSource = {
        uri: "https://api.dicebear.com/7.x/avataaars/png?seed=Coco&style=circle",
      };
    }
  }

  // Seçili olduğunda etrafında tema renginde bir halka oluştur
  const borderColor = focused ? color : "transparent";

  return (
    <View style={[styles.avatarContainer, { borderColor: borderColor }]}>
      {/* imageSource'un null olmadığından emin oluyoruz (TypeScript için) */}
      {imageSource && <Image source={imageSource} style={styles.avatarImage} />}
    </View>
  );
};
// ---------------------------

export default function MainNavigator() {
  const { colors, themeMode } = useTheme();

  return (
    <Tab.Navigator
      screenOptions={{
        headerShown: false,
        tabBarActiveTintColor: colors.primary,
        tabBarInactiveTintColor: colors.textMuted,
        tabBarStyle: {
          backgroundColor: colors.card,
          borderTopColor: colors.border,
          height: 65, // Biraz daha yükseklik
          paddingBottom: 10,
          paddingTop: 10,
          // Colorful modda köşeleri yuvarlat
          ...(themeMode === "colorful" && {
            position: "absolute",
            bottom: 15,
            left: 15,
            right: 15,
            borderRadius: 25,
            height: 70,
            paddingBottom: 15,
            borderTopWidth: 0,
            elevation: 5,
            shadowColor: "#000",
            shadowOpacity: 0.1,
          }),
        },
        tabBarLabelStyle: {
          fontSize: 11,
          fontWeight: "600",
        },
      }}
    >
      <Tab.Screen
        name="Home"
        component={DashboardScreen}
        options={{
          tabBarLabel: "Özet",
          tabBarIcon: ({ color, size }) => <Home color={color} size={size} />,
        }}
      />
      <Tab.Screen
        name="Tasks"
        component={TaskScreen}
        options={{
          tabBarLabel: "Görevler",
          tabBarIcon: ({ color, size }) => (
            <CheckSquare color={color} size={size} />
          ),
        }}
      />
      <Tab.Screen
        name="Pets"
        component={PetScreen}
        options={{
          tabBarLabel: "Pet",
          tabBarIcon: ({ color, size }) => (
            <PawPrint color={color} size={size} />
          ),
        }}
      />
      <Tab.Screen
        name="Kitchen"
        component={KitchenScreen}
        options={{
          tabBarLabel: "Mutfak",
          tabBarIcon: ({ color, size }) => (
            <Utensils color={color} size={size} />
          ),
        }}
      />

      {/* --- GÜNCELLENEN AYARLAR/PROFİL SEKMESİ --- */}
      <Tab.Screen
        name="Settings"
        component={SettingsScreen}
        options={{
          tabBarLabel: () => null, // Yazıyı gizle
          tabBarIcon: ({ color, focused }) => (
            // Özel avatar bileşenimizi burada kullanıyoruz
            <ProfileTabIcon color={color} focused={focused} />
          ),
        }}
      />
    </Tab.Navigator>
  );
}

const styles = StyleSheet.create({
  avatarContainer: {
    width: 32,
    height: 32,
    borderRadius: 16,
    borderWidth: 2, // Seçili olduğunda çerçeve kalınlığı
    justifyContent: "center",
    alignItems: "center",
    padding: 1, // Çerçeve ile resim arasında boşluk
  },
  avatarImage: {
    width: "100%",
    height: "100%",
    borderRadius: 15,
  },
});
